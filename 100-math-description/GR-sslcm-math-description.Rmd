---
title: "Mathematical Description"
subtitle: "State-Space Life Cycle  Model for Grande Ronde Spring Chinook Salmon"
output: 
  bookdown::pdf_document2:
    keep_tex: true
    toc: true
    toc_depth: 3
    number_sections: true
    citation_package: natbib
  # bookdown::word_document2:
  #   reference_docx: "C:/Users/bstaton/Desktop/Staton/3_general/Rmd-docx-template/Rmd-docx-template-basic-TNR.docx"
  #   number_sections: true
fontfamily: mathpazo
geometry: [top=1in,bottom=1in,left=1in,right=1in]
linkcolor: cyan
urlcolor: cyan
citecolor: black
bibliography: "GR-sslcm-cites.bib"
link-citations: "`r ifelse(knitr::is_latex_output(), 'true', 'false')`"
biblio-style: apalike
csl: "https://raw.githubusercontent.com/citation-style-language/styles/master/canadian-journal-of-fisheries-and-aquatic-sciences.csl"
editor_options: 
  chunk_output_type: console
header-includes:
  - \usepackage{natbib}
  - \usepackage{soul}
  - \setcitestyle{aysep={}}
  - \usepackage[hang,flushmargin,bottom]{footmisc}
  - \usepackage{microtype}
  - \usepackage{float}
  - \usepackage{xcolor}
  - \usepackage[textwidth=1.5in,tickmarkheight=3pt]{todonotes}
  - \setuptodonotes{backgroundcolor=black!40,textcolor=white,linecolor=black!65,bordercolor=black!65,size=footnotesize}
  - \usepackage[labelfont={bf,sc},labelsep=period]{caption}
  - \captionsetup{width=\textwidth}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \cfoot{\thepage}
  - \renewcommand{\headrulewidth}{0.5pt}
  - \renewcommand{\footrulewidth}{0.5pt}
  - \lfoot{State-Space Life Cycle Model\\Mathematical Description}
  - \rfoot{Grande Ronde Spring Chinook Salmon}
  - \usepackage{titlesec}
  - \titleformat{\section}{\bfseries\LARGE\scshape}{\thesection}{1em}{}
  - \titleformat{\subsection}{\bfseries\large}{\thesubsection}{1em}{}
  - \titleformat{\subsubsection}{\itshape}{\thesubsubsection}{1em}{}
  - \renewcommand{\contentsname}{Table of Contents}
  - \renewcommand{\eqref}[1]{\ref{#1}}
  - \newcommand{\fall}{\mathrm{fall}}
  - \newcommand{\spring}{\mathrm{spring}}
  - \newcommand{\NOR}{\mathrm{NOR}}
  - \newcommand{\HOR}{\mathrm{HOR}}
  - \newcommand{\CAT}{\mathrm{CAT}}
  - \newcommand{\LOS}{\mathrm{LOS}}
  - \newcommand{\MIN}{\mathrm{MIN}}
  - \newcommand{\UGR}{\mathrm{UGR}}
  - \newcommand{\WUL}{\mathrm{WUL}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
library(officedown)
```

```{r my-kable-fn}
my_kable = function(x, ...) {
  
  # detect the kable format
  kable_format = ifelse(is_latex_output(), "latex", "markdown")
  
  # build the kable with supplied options as well as my fixed defaults
  kable(x = x, format = kable_format, escape = FALSE, booktabs = TRUE, linesep = "", ...)
}
```

```{r bookdown-post-latex, eval = TRUE}
# https://github.com/rstudio/bookdown/issues/8#issuecomment-564689497
# easy method of placing bibliography somewhere other than at the end of the document always
options(bookdown.post.latex = function(x) {
  
  # x is the content of the LaTeX output file
  # str_replace can take a named vector of patterns and replacements
  replace_patterns <- c(
    "\\\\bibliography\\{GR-sslcm-cites.bib\\}" = "",         # Remove the default bibliography
    "^BIB HERE$" = "\\\\bibliography{GR-sslcm-cites.bib}"    # Add it in a new spot
  )
  
  stringr::str_replace_all(x, replace_patterns)
})
```

```{r highlight-fn}
highlight = function(note) {
  if (knitr::is_latex_output()) {
    paste0("\\hl{", note, "}")
  } else {
    ft = officer::fp_text(shading.color = "yellow", font.family = "Times New Roman", font.size = 11)
    officer::ftext(toString(note), prop = ft)
  }
}
```

```{r new-commands, results = "asis"}
# these are shortcut math mode commands
# the hspace helps the appearance in latex, but it won't render to word
# the code below removes it if rendered to word output
commands = c(
  "\\renewcommand*{\\log}{\\mathrm{log}\\hspace{-0.20em}}",
  "\\renewcommand*{\\max}{\\mathrm{max}\\hspace{-0.20em}}",
  "\\newcommand{\\logit}{\\mathrm{logit}\\hspace{-0.20em}}",
  "\\newcommand{\\ilogit}{\\mathrm{logit}^{-1}\\hspace{-0.20em}}",
  "\\newcommand{\\MVNdist}{\\mathcal{MVN}\\hspace{-0.20em}}",
  "\\newcommand{\\Ndist}{\\mathcal{N}\\hspace{-0.20em}}",
  "\\newcommand{\\Bdist}{\\mathcal{B}\\hspace{-0.20em}}",
  "\\newcommand{\\Mdist}{\\mathcal{M}\\hspace{-0.20em}}"
)

if (!is_latex_output()) {
  commands = stringr::str_remove(commands, "\\\\hspace\\{-0\\.20em\\}")
}

cat(commands, sep = "\n")
```

\pagenumbering{gobble}
\clearpage
\pagenumbering{arabic}

# Model Overview

The purpose of developing the state-space life cycle model for Grande Ronde spring Chinook salmon is to estimate posterior distributions of population dynamics parameters (e.g., average survival, rearing capacity, coefficients of relationships linking life stages, etc.).
These posterior distributions can ultimately be sampled from to parameterize simulation models that evaluate habitat restoration and climate change scenarios grounded in empirical monitoring data.
The model tracks the cohort-specific abundance of fish through various life stages and links these "state variables" over time across cohorts via production relationships (e.g., spawners produce eggs) or within cohorts via transition probabilities (e.g., parr become smolt after surviving overwinter).
The model integrates many different data sources and fits to them simultaneously in a single joint likelihood; these data sources include rotary screw trap passage estimates, a variety of PIT tag-derived survival estimates, mean length data, hatchery smolt releases, adult return abundance, and the composition of adult returns by age and origin; other data sources that are used but are not fitted to include hatchery smolt release abundances, harvest information, fecundity estiamtes, and numbers of returning adults removed for hatchery operations.
Four spawning populations within the Grande Ronde basin are simultaneously analyzed: Catherine Creek (CAT), Lostine River (LOS), Minam River (MIN) and the upper Grande Ronde River (UGR; `r highlight("FIGURE REFERENCE: map")`), and where relevant, the model stratifies life stages by juvenile migratory strategy (fall vs. spring migrants), rearing origin type (spawned in hatchery vs. natural setting), and adult return age (total age of 3, 4, or 5 years).

Central to the notion of a "state-space" model is the partitioning of variability in the observed data sets into two types: (_i_) process noise, i.e., variability in the biological and environmental processes that produce population outcomes and (_ii_) observation error, i.e., variability in the measurement processes that result in an imperfect perception of the true value being measured.
This is accomplished by (_i_) specifying a set of process equations that represent expected population responses to intrinsic (e.g., density affects survival) and extrinsic (e.g., quantity of available habitat affects capacity) drivers, (_ii_) adding process noise to obtain the "realized" or "latent" (i.e., true but partially or imperfectly observed) state, and (_iii_) assuming the data values have been observed conditioned on the latent values.
The model does not attempt to estimate the magnitude of both process and observation noise variance; it is supplied estimates of the latter and attributes the remaining noise unexplained by process equations to process noise.
This aspect critical because only variability due to the processes is of interest for parameterizing simulation models of future population dynamics, yet the data sets vary in their precision.
Further, the state-space model is inherently a time series model, making it suitable for handling the time lags and linkages involved with modeling age-structured populations.

Bayesian methods were used to fit the state-space life cycle model to data, as it is intuitive for the necessary integration over the many layers of uncertainty (i.e., process vs. observational variability).
Further, Bayesian inference provides an intuitive framework to constrain parameters to take on only values known _a priori_ to be plausible -- mostly uninformative priors were intentionally used but several cases involved priors that were moderately or strongly informative.
An additional benefit of using the Bayesian framework is the seamless propagation of uncertainty from estimated parameters to derived quantities -- all unknown quantities receive a posterior distribution.
Markov Chain Monte Carlo methods [MCMC, implemented via the JAGS v4.3.1 probabilistic programming language, @plummer-2003] were used to sample from the joint posterior distribution.

`r if (is_latex_output()) "\\newpage"`

# Syntactical and Statistical Conventions

The state-space life cycle model symbology aims for consistency in mathematical representation of quantities but this has created some conventions that require devoted explanation.
All quantities are defined in Tables \@ref(tab:index-table), \@ref(tab:symbol-table), \@ref(tab:param-table), and \@ref(tab:data-table) and a catalog of all equations is provided in Table \@ref(tab:equation-table).

* For simplicity, the term "adult" is used to refer to any mature individual returning to spawn, including age-3 "jacks".
* Life stage-specific states are defined by capital letters, these include: eggs ($E$), parr ($P$), smolt ($M$), ocean juveniles ($O$), adults returning to river ($R$), or adults with potential to spawn ($S$).
* Parameters (e.g., survival terms, non-survival transition probabilities, coefficients in relationships, etc.) are predominately denoted by Greek symbols and are used consistently where possible, e.g., $\phi$ for survival rates or $\psi$ for maturation rates.
* Subscripts denote placement of a quantity in a larger array (i.e., the index), e.g., $y$ denotes a specific year and $j$ a specific population (see Table \@ref(tab:index-table)).
* Superscripts are most often used syntactically to further describe the quantity, not in a mathematical sense.
E.g., $M^{b}$ represents smolt abundance _before_ out-of-basin migration and $M^{a}$ represents smolt abundance _after_ out-of-basin migration.
As such, $M^{b}$ is not "$M$ raised to the power $b$"; if the quantity $M^{b}$ must be raised to the power $c$, it will be written $(M^{b})^c$.
* Survival terms to transition from state $A$ to state $B$ in year $y$ for population $j$ are denoted by $\phi^{A \to B}_{y,j}$.
* The expected value of a stochastic process is expressed by a dot, e.g., $\dot{\phi}^{A \to B}_j$ -- this is the value expected in the absence of process (biological/environmental) variability.
* In some cases, calculations are performed on vectors rather than scalars.
Vectors are denoted via boldface, and the dimension of the vector is denoted using 1:$n$ syntax. E.g., $\boldsymbol{\phi}^{A \to B}_{y,1:n_j}$ represents a vector of parameters representing the transition (survival) probability from state $A$ to state $B$ in year $y$, where each element stores the value for each population.
* Mathematical operations performed on two vectors $\boldsymbol{C}$ and $\boldsymbol{D}$ are performed in an element-wise fashion, and the resulting vector will have identical dimensions to both $\boldsymbol{C}$ and $\boldsymbol{D}$.
* In some cases, a calculation is performed differently for a subset of the possible index values. For example, to denote that $k$ should take on only the values of 1 and 3 (not 2), we would write, $k \in [1,3]$.
* $\log\left(x\right)$ represents the natural logarithm of $x$ and it is implied that the constraint $x > 0$ is satisfied.
* $\logit\left(p\right)$ represents the log odds of $p$ (i.e., $\log\left[p/(1-p)\right])$) and it is implied that the constraint $0 < p < 1$ is satisfied.
* All quantities are used in a likelihood component are denoted by a "hat", e.g., a survival term ($\hat{\phi}^{A \to B}_{y,j}$) and its logit-normal standard error ($\hat{\sigma}_{\phi^{A \to B}_{y,j}}$, which is used as a direct estimate of observation error variability).
* Stochastic processes are represented by $x_{y} \sim \mathcal{F}(\theta_{1}, \theta_{2})$, where $x_{y}$ is a random variable, $\mathcal{F}$ is some probability density (mass) function ($\mathcal{N}$ is univariate normal, $\mathcal{MVN}$ is multivariate normal, $\mathcal{B}$ is binomial, and $\mathcal{M}$ is multinomial), and $\theta_{1}$ and $\theta_{2}$ are parameters of the probability distribution.

Process noise is modeled by assuming year-specific values are multivariate logit-normal random variables around the deterministic value.
This enables modeling covariability in demographic rates [@riecke-etal-2019; @bouchard-etal-2022] among populations or origins, which is advantageous for estimation involving incompletely overlapping time series and quantifies synchrony in demographic rates which influences the stability of the return aggregated across populations [@thorson-etal-2014; @connors-etal-2022].
The covariance matrices of these random variables are denoted by $\Sigma$, and have a common structure for all model components.
Take the hypothetical survival term $\phi^{A \to B}_{y,j}$ as an example.
The random process introducing inter-annual variability and inter-population covariability is expressed as:

\begin{equation}
\logit\left(\boldsymbol{\phi}^{A \to B}_{y,1:n_j}\right) \sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\phi}}^{A \to B}_{y,1:n_j}\right), \Sigma_{\phi^{A \to B}} \right]
(\#eq:generic-random)
\end{equation}

where $\Sigma_{\phi^{A \to B}}$ is an $n_j \times n_j$ matrix constructed of population-specific variance terms $\left(\sigma_{\phi^{A \to B}_j}\right)^2$ and correlation terms specific to each pair of populations $j$ and $j^\prime$ $\rho_{\phi^{A \to B}_{j,j^{\prime}}}$:

\begin{equation}
\left[
\begin{array}{cccc}
\left(\sigma_{\phi^{A \to B}_{j=1}}\right)^2 & \sigma_{\phi^{A \to B}_{j=1}} \cdot \sigma_{\phi^{A \to B}_{j=2}} \cdot \rho_{\phi^{A \to B}_{j=1,j^{\prime}=2}} & \dots & \sigma_{\phi^{A \to B}_{j=1}} \cdot \sigma_{\phi^{A \to B}_{j=n_j}} \cdot \rho_{\phi^{A \to B}_{j=1,j^{\prime}=n_j}} \\
\sigma_{\phi^{A \to B}_{j=2}} \cdot \sigma_{\phi^{A \to B}_{j=1}} \cdot \rho_{\phi^{A \to B}_{j=2,j^{\prime}=1}} & \left(\sigma_{\phi^{A \to B}_{j=2}}\right)^2 & \dots & \sigma_{\phi^{A \to B}_{j=2}} \cdot \sigma_{\phi^{A \to B}_{j=n_j}} \cdot \rho_{\phi^{A \to B}_{j=2,j^{\prime}=n_j}} \\
\vdots & \vdots & \ddots & \vdots \\
\sigma_{\phi^{A \to B}_{j=n_j}} \cdot \sigma_{\phi^{A \to B}_{j=1}} \cdot \rho_{\phi^{A \to B}_{j=n_j,j^{\prime}=1}} & \sigma_{\phi^{A \to B}_{j=n_j}} \cdot \sigma_{\phi^{A \to B}_{j=2}} \cdot \rho_{\phi^{A \to B}_{j=n_j,j^{\prime}=2}} & \dots & \left(\sigma_{\phi^{A \to B}_{j=n_j}}\right)^2
\end{array}
\right]
(\#eq:generic-Sigma4by4)
\end{equation}

In cases where a quantity varies annually and covaries by origin but is identical across populations, $\Sigma_{\phi^{A \to B}}$ would have dimensions $n_o \times n_o$:

\begin{equation}
\left[
\begin{array}{cc}
\left(\sigma_{\phi^{A \to B}_{o=1}}\right)^2 & \sigma_{\phi^{A \to B}_{o=1}} \cdot \sigma_{\phi^{A \to B}_{o=2}} \cdot \rho_{\phi^{A \to B}} \\
\sigma_{\phi^{A \to B}_{o=2}} \cdot \sigma_{\phi^{A \to B}_{o=1}} \cdot \rho_{\phi^{A \to B}} & \left(\sigma_{\phi^{A \to B}_{o=2}}\right)^2
\end{array}
\right]
(\#eq:generic-Sigma2by2)
\end{equation}

These covariance matrices were estimated by assigning their inverse ($\Sigma^{-1}$) a scaled Wishart prior distribution [@gelman-etal-2014; @plummer-2017, Table \@ref(tab:param-table)].
Although the stochastic process requires the $\Sigma$ term, it is the component $\sigma$ and $\rho$ terms that were of interest for inference.

\clearpage

# Freshwater Juvenile Phase

## Process Model

### Egg Production, Parr Recruitment, and Parr Mean Length

The life cycle begins at the egg stage immediately after spawning.
Total egg production was the sum product of age-specific spawner abundance ($S^{a}_{y,k,o,j}$, from eq. \@ref(eq:get-Sa), below), proportion female-at-age ($\Omega_k$), and fecundity-at-age ($f_{y,k,j}$):

\begin{equation}
E_{y,j} = \sum_o^{n_o} \sum_k^{n_k} S^{a}_{y,k,o,j} \cdot \Omega_{k} \cdot f_{y,k,j}
(\#eq:get-E)
\end{equation}

Spawners of age-4 or age-5 were assumed to be 50% female and age-3 spawners were assumed 100% male (i.e., $\Omega_{k=1} = 0;\;\Omega_{k \in [2,3]} = 0.5$; approximately equal to values estimated from carcass data).
Fecundity was predicted from length-fecundity relationships based on Grande Ronde-origin hatchery broodstock and time-varying mean length-at-age data.
Both $\Omega_k$ and $f_{y,k,j}$ were assumed known without error.

Expected egg-to-parr survival was assumed to be a density-dependent process following Beverton-Holt dynamics with "productivity" parameter $\alpha_j$ (i.e., theoretical maximum egg-to-parr survival probability, in the absence of density effects) and capacity parameter $\beta_j$ (i.e., theoretical maximum parr recruitment abundance):

\begin{equation}
\dot{\phi}^{E \to P^{b}}_{y,j} = \frac{1}{\frac{1}{\alpha_j} + \frac{E_{y,j}}{\beta_j}}
(\#eq:get-phi-E-Pb-dot)
\end{equation}

To facilitate later analyses (not documented here) investigating the effects of habitat restoration and climate change on population dynamics, parr capacity was modeled as a function of weighted usable habitat length specific to each population ($\WUL_j$)^[Derivation of $\WUL_j$ is too detailed to describe fully here.
Briefly, the relative ability of stream segments with different habitat characteristics to hold rearing parr was expressed in terms of the density of fish predicted to reside there by a complex generalized linear mixed model.
The model was fitted to density estimates based on detectability-adjusted [@staton-etal-2022] summer snorkel counts with local habitat characteristics (e.g., pool frequency, water temperature, large wood density, etc.) as predictor variables.
The weight of each stream segment was assigned based on the predicted density relative value to the segment with the highest value; $\WUL_j$ was then equal to the sum of segment-specific weight and length within the known spawning and rearing extent for each population.]:

\begin{equation}
\log\left(\beta_j\right) \sim \Ndist\left[\log\left(\lambda \cdot \WUL_j\right), \sigma_{\beta} \right]
(\#eq:beta-random)
\end{equation}

where $\lambda$ is the expected change in parr capacity per 1 km change in weighted usable habitat length, and $\sigma_{\beta}$ is the log-normal standard deviation of variability in this relationship not captured by $\WUL$ values.

Realized (i.e., with process noise) egg-to-parr survival was a multivariate logit-normal random variable around the expected value ($\dot{\phi}^{E \to P^{b}}_{y,j}$) from eq. \@ref(eq:get-phi-E-Pb-dot).
Rather than assume egg-to-parr survival anomalies (i.e., inter-annual variability in egg-to-parr survival beyond that explained by density-dependence) are completely random across years, a lag-1 autoregressive process [AR(1); coefficient denoted $\kappa^{E \to P^{b}}_{j}$] was used to account for serial autocorrelation:

\begin{equation}
\logit\left(\boldsymbol{\phi}^{E \to P^{b}}_{y,1:n_j}\right) \sim \MVNdist\left\{\logit\left(\boldsymbol{\dot{\phi}}^{E \to P^{b}}_{y,1:n_j}\right) + \boldsymbol{\kappa}^{E \to P^{b}}_{1:n_j} \cdot \left[\logit\left(\boldsymbol{\phi}^{E \to P^{b}}_{y-1,1:n_j}\right) - \logit\left(\boldsymbol{\dot{\phi}}^{E \to P^{b}}_{y-1,1:n_j}\right)\right], \Sigma_{\phi^{E \to P^{b}}} \right\}
(\#eq:phi-E-Pb-random)
\end{equation}

Thus, the covariance matrix $\Sigma_{\phi^{E \to P^{b}}}$ captures variability in the white noise (i.e., non-correlated) portion of the survival anomaly.
Total parr recruitment ($P^{b}_{y,j}$) was then the product of total egg production and egg-to-parr survival:

\begin{equation}
P^{b}_{y,j} = \phi^{E \to P^{b}}_{y,j} \cdot E_{y,j}
(\#eq:get-Pb)
\end{equation}

In addition to density-dependent egg-to-parr survival (eq. \@ref(eq:get-phi-E-Pb-dot)), there was reason to expect that parr growth/size is density-dependent, both from the literature on salmonid early life history [@grant-imre-2005; @copeland-venditti-2009; @walters-etal-2013; @myrvold-kennedy-2015; @grossman-simon-2020] and previous analyses on Grande Ronde Spring Chinook salmon populations [@cooney-etal-2017; @justice-etal-2023].
Given the established relationships between size and survival  [@zabel-achord-2004; @hostetter-etal-2015], growth and density [e.g., @grant-imre-2005], and survival and density [@achord-etal-2003; @walters-etal-2013], it is possible that growth could be a useful mechanism to model density effects on post-recruitment juvenile survival.
Expected parr mean length ($\dot{L}^{P^{b}}_{y,j}$, mm fork length) was modeled as a power function of egg density, which expressed on the logarithmic scale was:

\begin{equation}
\log\left(\dot{L}^{P^{b}}_{y,j}\right) = \omega_{0,j} + \omega_{1,j} \cdot \log\left(\frac{E_{y,j}}{\WUL_j}\right)
(\#eq:get-L-Pb-dot)
\end{equation}

and the realized parr mean length as being multivariate log-normally distributed around $\dot{L}^{P^{b}}_{y,j}$ with covariance matrix $\Sigma_{L^{P^{b}}}$:

\begin{equation}
\log\left(\boldsymbol{L}^{P^{b}}_{y,1:n_j}\right) \sim \MVNdist\left[\log\left(\boldsymbol{\dot{L}}^{P^{b}}_{y,1:n_j}\right), \Sigma_{L^{P^{b}}}\right]
(\#eq:L-Pb-random)
\end{equation}

### Migratory Strategy Apportionment

Like many populations of stream-type spring Chinook salmon in the Columbia River basin, those in the Grande Ronde display life history diversity with respect to juvenile migratory phenology and overwinter rearing habitat use [copeland-etal-2014].
Some portion of parr recruits ($P^{b}_{y,j}$)  migrate from the headwaters rearing areas in the fall and rear overwinter farther downstream (termed "fall migrants" and indexed by $i = \fall$) and the remaining portion migrate the following spring during the out-of-basin migration (termed "spring migrants" and indexed by $i = \spring$).
Due to this difference in migratory phenology, these two groups of fish are monitored separately (`r highlight("REPORT CITATION NEEDED")`) depending on when they pass the rotary screw trap located in each tributary (`r highlight("FIGURE REFERENCE: map")`).
Separate abundance and survival data in the observation model required that the process model track fish using these strategies separately, thus they were apportioned:

\begin{equation}
P^{a}_{y,i,j} = P^{b}_{y,j} \cdot \pi_{y,i,j}
(\#eq:get-Pa)
\end{equation}

where $P^{a}_{y,i,j}$ is migratory strategy-specific parr abundance and $\pi_{y,i,j}$ is the proportion that take on each migratory strategy.
The expected value of the proportion of fall migrants ($\dot{\pi}_{i = \fall,j}$) was assumed to be time-constant and the realized values were modeled as having a multivariate logit-normal distribution with covariance matrix $\Sigma_{\pi_{i = \fall}}$:

\begin{equation}
\logit\left(\boldsymbol{\pi}_{y,i = \fall,1:n_j}\right) \sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\pi}}_{i = \fall,1:n_j}\right), \Sigma_{\pi_{i = \fall}}\right]
(\#eq:pi-random)
\end{equation}

With only two migratory strategies, the proportion that were spring migrants was obtained as the complement: $\pi_{y,i = \spring,j} = 1 - \pi_{y,i = \fall,j}$.

### Survival to Smolt Stage and Smolt Mean Length

The model assumed that some inter-annual variability in overwinter survival (i.e., the transition from age-1 parr to age-2 smolt prior to out-migration) can be explained by parr mean length^[The assumption that parr length is related to overwinter survival can be relaxed by forcing $\gamma_{1,j}$ in eq. \@ref(eq:get-phi-Pa-Mb-dot) to zero rather than assigning it an uninformative prior distribution; in this case overwinter survival would be assumed to fluctuate around a time-constant expected value.].
This was achieved by modeling expected overwinter survival (denoted by $\dot{\phi}^{P^{a} \to M^{b}}_{y,i,j}$) as a logit-linear function of parr mean length:

\begin{equation}
\logit\left(\dot{\phi}^{P^{a} \to M^{b}}_{y,i,j}\right) = \gamma_{0,i,j} + \gamma_{1,j} \cdot L^{*P^{b}}_{y,j}
(\#eq:get-phi-Pa-Mb-dot)
\end{equation}

where $L^{*P^{b}}_{y,j}$ is parr mean length centered and scaled based on the mean and standard deviation of observed mean lengths (denoted $\hat{L}^{P^{b}}_{y,j}$) across years for population $j$, respectively.
Thus, $\gamma_{0,i,j}$ represents the expected log-odds of survival for type $i$ in population $j$ in a year with average parr mean length, and $\gamma_{1,j}$ represents the expected change in the log-odds for every additional standard deviation increase in parr mean length.
Then, for each migratory strategy separately, realized overwinter survival was a multivariate logit-normal random variable around the expected value with covariance matrix $\Sigma_{\phi^{P^{a} \to M^{b}}}$ (assumed common among migratory strategies):

\begin{equation}
\logit\left(\boldsymbol{\phi}^{P^{a} \to M^{b}}_{y,i,1:n_j}\right) \sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\phi}}^{P^{a} \to M^{b}}_{y,i,1:n_j}\right), \Sigma_{\phi^{P^{a} \to M^{b}}}\right]
(\#eq:phi-Pa-Mb-random)
\end{equation}

The abundance of natural origin smolt (indexed by $o=\NOR$, hatchery-origin smolt releases described in Section \@ref(hatchery-inputs)) before out-migration was then:

\begin{equation}
M^{b}_{y,i,o=\NOR,j} = P^{a}_{y,i,j} \cdot \phi^{P^{a} \to M^{b}}_{y,i,j}
(\#eq:get-Mb-NOR)
\end{equation}

Similar to the use of parr mean length to explain inter-annual variability in overwinter survival, smolt mean length ($L^{M^{b}}_{y,j}$) may be useful for explaining inter-annual variability in out-migration survival.
Only spring migrant smolt have been measured for mean length (as they pass the screw trap), thus the $i$ subscript is omitted from quantities related to smolt mean length.
Preliminary analyses revealed that smolt mean length was positively related to parr mean length, but that the relationship was non-linear.

Preliminary analyses on the observed mean length data revealed that smolt mean length was positively related with parr mean length, but that the relationship was non-linear [@justice-etal-2023].
This non-linearity was captured by modeling the expected multiplicative change in mean length from the parr to smolt stages as a log-linear function of (scaled and centered) parr mean length:

\begin{equation}
\log\left(\dot{\Delta}^{L^{P^{b}} \to L^{M^{b}}}_{y,j}\right) = \theta_{0,j} + \theta_{1,j} \cdot L^{*P^{b}}_{y,j}
(\#eq:get-Delta-L-Pb-L-Mb-dot)
\end{equation}

The realized multiplicative change in mean length was multivariate log-normally distributed around $\dot{\Delta}^{L^{P^{b}} \to L^{M^{b}}}_{y,j}$ with covariance matrix $\Sigma_{\Delta^{L^{P^{b}} \to L^{M^{b}}}}$:

\begin{equation}
\log\left(\boldsymbol{\Delta}^{L^{P^{b}} \to L^{M^{b}}}_{y,1:n_j}\right) \sim \MVNdist\left[\log\left(\boldsymbol{\dot{\Delta}}^{L^{P^{b} \to L^{M^{b}}}}_{y,1:n_j}\right), \Sigma_{\Delta^{L^{P^{b}} \to L^{M^{b}}}}\right]
(\#eq:Delta-L-Pb-L-Mb-random)
\end{equation}

Smolt mean length was then the product:

\begin{equation}
L^{M^{b}}_{y,j} = L^{P^{b}}_{y,j} \cdot \Delta^{L^{P^{b}} \to L^{M^{b}}}_{y,j}
(\#eq:get-L-Mb)
\end{equation}

### Hatchery Inputs

For populations with hatchery supplementation (CAT, LOS, and UGR), hatchery-origin smolt releases (assumed known without error; `r highlight("REPORT CITATION NEEDED")`) were stored in the variable $M^{b}_{y,i=\spring,o=\HOR,j}$; the very rare occasions in which hatchery-origin parr were released the prior year were ignored, thus $M^{b}_{y,i=\fall,o=\HOR,j} = 0$ for all $y$ and $j$.
Abundance (and often survival) of hatchery-origin fish was tracked separately from natural-origin fish for all subsequent life stages.

### Seaward Migration

The model separates mortality sources experienced during seaward migration into two stages: (_i_) from the natal tributary to Lower Granite Dam (LGR), the first in a series of eight hydroelectric dams encountered during the downstream migration through the Snake and Columbia rivers, and (_ii_) from LGR to the ocean.
Mortality source (_i_) was not identifiable when separated by migratory strategy, thus it was assumed identical between natural-origin fall and spring migrants (i.e., $\phi^{M^{b} \to M^{a}}_{y,i=\fall,o=\NOR,j} = \phi^{M^{b} \to M^{a}}_{y,i=\spring,o=\NOR,j}$ for all $j$ and $y$); the $i$ dimension is thus omitted when defining these quantities below.
Both mortality sources were separable by origin type (see Section \@ref(survival-data-sources))

Expected out-of-basin migration survival for natural-origin smolt was a logit-linear function of smolt mean length:

\begin{equation}
\logit\left(\dot{\phi}^{M^{b} \to M^{a}}_{y,o=\NOR,j}\right) = \tau_{0,j} + \tau_{1,j} \cdot L^{*M^{b}}_{y,j}
(\#eq:get-phi-Mb-Ma-dot)
\end{equation}

where $L^{*M^{b}}_{y,j}$ has been centered and scaled on the measured smolt mean length values ($\hat{L}^{M^{b}}_{y,j}$), just as for $L^{*P^{b}}_{y,j}$ in eqs. \@ref(eq:get-phi-Pa-Mb-dot) and \@ref(eq:get-Delta-L-Pb-L-Mb-dot).
For hatchery-origin smolt, expected out-of-basin survival was assumed to be time-constant (i.e., all $\dot{\phi}^{M^{b} \to M^{a}}_{y,o=\HOR,j}$ were equal within a population).
For each origin separately, realized out-of-basin migration survival was a multivariate logit-normal random variable around the expected value with covariance matrix $\Sigma_{\phi^{M^{b} \to M^{a}}}$ (assumed common across origin types):

\begin{equation}
\logit\left(\boldsymbol{\phi}^{M^{b} \to M^{a}}_{y,o,1:n_j}\right) \sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\phi}}^{M^{b} \to M^{a}}_{y,o,1:n_j}\right), \Sigma_{\phi^{M^{b} \to M^{a}}}\right]
(\#eq:phi-Mb-Ma-random)
\end{equation}

and the abundance of smolt reaching LGR after surviving the migration out-of-basin was:

\begin{equation}
M^{a}_{y,i,o,j} = M^{b}_{y,i,o,j} \cdot \phi^{M^{b} \to M^{a}}_{y,o,j}
(\#eq:get-Ma)
\end{equation}

Survival during the downstream migration through the hydrosystem on the Snake and Columbia rivers was modeled as a single survival rate, specific to each year and origin but shared among populations ($\phi^{M^{a} \to O^{0}}_{y,o}$).
Realized survival rates were multivariate logit-normal random variables around a time-constant expected value ($\dot{\phi}^{M^{a} \to O^{0}}_{o}$) with covariance matrix $\Sigma_{\phi^{M^{a} \to O^{0}}}$:

\begin{equation}
\logit\left(\boldsymbol{\phi}^{M^{a} \to O^{0}}_{y,1:n_o}\right) \sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\phi}}^{M^{a} \to O^{0}}_{1:n_o}\right), \Sigma_{\phi^{M^{a} \to O^{0}}}\right]
(\#eq:phi-Ma-O0-random)
\end{equation}

and the abundance of fish reaching the ocean by origin and population was:

\begin{equation}
O^{0}_{y,o,j} = \phi^{M^{a} \to O^{0}}_{y,o} \sum_i^{n_i} M^{a}_{y,i,o,j}
(\#eq:get-O0)
\end{equation}

The summation across migration strategies ($i$) in eq. \@ref(eq:get-O0) indicates that the fates of fish with differing migratory strategies were not tracked separately after the $M^{a}_{y,i,o,j}$ stage.

## Observation Model

The observation model components for the freshwater juvenile life stage were fitted to three primary data types: (_i_) abundance of juveniles passing rotary smolt traps (located in each tributary, `r highlight("REPORT CITATION NEEDED")`) in either the fall or spring, (_ii_) survival of juveniles from several PIT-tagging events to LGR (`r highlight("REPORT CITATION NEEDED")`), and (_iii_) the mean length of sampled individuals during two of the PIT-tagging events (`r highlight("REPORT CITATION NEEDED")`).
For all types, the information supplied to the model were externally compiled estimates (e.g., survival from Cormack-Jolly-Seber models) and the estimated standard error was supplied to the model as a measure of observation error variability.

An even more fully integrated model would involve constructing the join likelihood based on the frequency of PIT-tag detection histories.
This was deemed unnecessary given (_a_) external estimates have been pre-compiled as well as their estimates of uncertainty (thus the model is consistent with published/established estimates), (_b_) much additional observational model complexity would be needed (e.g., detection probabilities), and (_c_) it would be unlikely to lead to greater parameter identifiability in the process model (e.g., allowing $\phi^{M^{b} \to M^{a}}_{y,i=\fall,o=\NOR,j} \ne \phi^{M^{b} \to M^{a}}_{y,i=\spring,o=\NOR,j}$).
The practice of performing estimation based on raw data versus pre-compiled estimates that are treated as data is recommended to be avoided, especially if the uncertainty in pre-compiled estimates cannot be acknowledged [@brooks-deroba-2015].
However, @staton-etal-2017a investigated this topic in the context of state-space (adult-to-adult age-structured spawner-recruit) models and found little difference in inferences between models that were integrated to varying degrees with respect to the extent of data pre-compilation, so long as uncertainty from the compilation step is accounted for.

### Abundance Data Sources

Fish with the fall migratory strategy pass the screw trap in the fall as parr and fish with the spring migratory strategy pass the screw trap the following spring as smolt.
The estimated passage abundances during these time periods were used in log-normal likelihoods by assuming:

\begin{equation}
\log\left(\hat{P}^{a}_{y,i=\fall,j}\right) \sim \Ndist\left[\log\left(P^{a}_{y,i=\fall,j} \right), \hat{\sigma}_{P^{a}_{y,i=\fall,j}}\right]
(\#eq:fall-count-data)
\end{equation}

for the fall screw trap estimate and

\begin{equation}
\log\left(\hat{M}^{b}_{y,i=\spring,o=\NOR,j}\right) \sim \Ndist\left[\log\left(M^{b}_{y,i=\spring,o=\NOR,j}\right), \hat{\sigma}_{M^{b}_{y,i=\spring,o=\NOR,j}}\right]
(\#eq:spring-count-data)
\end{equation}

for the spring screw trap estimate.

### Survival Data Sources

Natural-origin juveniles have been PIT-tagged during four separate events in most years and populations: (_i_) in summer prior to migratory strategy divergence, (_ii_) as fall migrant parr that pass the screw trap in the fall, (_iii_) in winter in the headwaters (after fall migrants leave, thus applies only to spring migrants; also not available for Minam River), and (_iv_) as spring migrant smolt pass the screw trap.
Hatchery-origin smolt released in the spring were also PIT-tagged prior to release.
All five of these tag groups have their survival estimated from the time of tagging to their arrival at LGR.
These estimates (and their associated standard errors) were used in logit-normal likelihoods by assuming the following for each tag group.

Summer tag group:

\begin{equation}
\logit\left(\hat{\phi}^{P^{b} \to M^{a}}_{y,j}\right) \sim \Ndist\left[\logit\left(\frac{\sum_{i}^{n_i} M^{a}_{y,i,o=\NOR,j}}{P^{b}_{y,j}}\right),\hat{\sigma}_{\phi^{P^{b} \to M^{a}}_{y,j}}\right]
(\#eq:summer-surv-data)
\end{equation}

Fall tag group:

\begin{equation}
\logit\left(\hat{\phi}^{P^{a} \to M^{a}}_{y,i=\fall,j}\right) \sim \Ndist\left[\logit\left(\frac{M^{a}_{y,i=\fall,o=\NOR,j}}{P^{a}_{y,i=\fall,j}}\right),\hat{\sigma}_{\phi^{P^{a} \to M^{a}}_{y,i=\fall,j}}\right]
(\#eq:fall-surv-data)
\end{equation}

Winter tag group:

\begin{equation}
\logit\left(\hat{\phi}^{P^{a} \to M^{a}}_{y,i=\spring,j}\right) \sim \Ndist\left[\logit\left(\frac{M^{a}_{y,i=\spring,o=\NOR,j}}{P^{a}_{y,i=\spring,j} \cdot \phi^{P^{b} \to P^{a}}_{j}}\right),\hat{\sigma}_{\phi^{P^{a} \to M^{a}}_{y,i=\spring,j}}\right]
(\#eq:winter-surv-data)
\end{equation}

(where $\phi^{P^{b} \to P^{a}}_j$ is a time-constant model-estimated survival from summer tagging to winter tagging for parr that ultimately become spring migrants and $j \in [\CAT, \LOS, \UGR]$).

Spring tag group:

\begin{equation}
\logit\left(\hat{\phi}^{M^{b} \to M^{a}}_{y,i=\spring,o=\NOR,j}\right) \sim \Ndist\left[\logit\left(\phi^{M^{b} \to M^{a}}_{y,i=\spring,o=\NOR,j}\right),\hat{\sigma}_{\phi^{M^{b} \to M^{a}}_{y,i=\spring,o=\NOR,j}}\right]
(\#eq:spring-surv-data)
\end{equation}

Hatchery smolt tag group:

\begin{equation}
\logit\left(\hat{\phi}^{M^{b} \to M^{a}}_{y,i=\spring,o=\HOR,j}\right) \sim \Ndist\left[\logit\left(\phi^{M^{b} \to M^{a}}_{y,i=\spring,o=\HOR,j}\right),\hat{\sigma}_{\phi^{M^{b} \to M^{a}}_{y,i=\spring,o=\HOR,j}}\right]
(\#eq:spring-surv-HOR-data)
\end{equation}

for hatchery-origin smolt releases ($j \in [\CAT, \LOS, \UGR]$).

Much research has been devoted to studying the survival of Chinook salmon smolts migrating through the hydrosystem on the Snake and Columbia rivers. 
In particular, the Comparative Survival Study has tracked the survival of a variety of tagging groups going back to the early 2000s; estimates from a recent report [@mccann-etal-2020, Table A.1 on page A-20 therein] were used to serve as empirical observations (with estimates of uncertainty) with which to inform this component of our model.
Provided by @mccann-etal-2020 are annual estimates of in-stream survival along the migration from LGR through Bonneville Dam (BON); separate time series are available for natural-origin (we used the "Aggregate Wild Chinook" estimates as none were available for Grande Ronde populations only, denoted $\hat{\phi}^{M^{a} \to O^{0}}_{y,o=\NOR}$ here) and for hatchery-origin (we used the "Catherine Creek AP" estimates, denoted $\hat{\phi}^{M^{a} \to O^{0}}_{y,o=\HOR}$ here).
These estimates were treated as representative of the survival for each population, which implies an assumption that the different populations experienced similar conditions during this migration and attributes all variability to either random process or observation noise (i.e., no factors known to influence hydrosystem survival such as size, flood pulses, barging intensity were included).
Similar to the other survival data sets, these estimates were assumed to have been made with logit-normal random error around the process model values to build the likelihood:

\begin{equation}
\logit\left(\hat{\phi}^{M^{a} \to O^{0}}_{y,o}\right) \sim \Ndist\left[\logit\left(\phi^{M^{a} \to O^{0}}_{y,o}\right),\hat{\sigma}_{\phi^{M^{a} \to O^{0}}_{y,o}}\right]
(\#eq:hydro-surv-data)
\end{equation}

### Mean Length Data Sources

Individual fish lengths have been measured upon capture for PIT-tagging (`r highlight("REPORT CITATION NEEDED")`).
The mean length (and the associated standard errors) of all captured fish (tagged and untagged; only fish $\ge$ 55mm can receive a PIT-tag) was used in log-normal likelihoods by assuming:

\begin{equation}
\log\left(\hat{L}^{P^{b}}_{y,j}\right) \sim \Ndist\left[\log\left(L^{P^{b}}_{y,j}\right), \hat{\sigma}_{L^{P^{b}}_{y,j}}\right]
(\#eq:L-Pb-data)
\end{equation}

for mean length data for the summer parr tagging group and

\begin{equation}
\log\left(\hat{L}^{M^{b}}_{y,j}\right) \sim \Ndist\left[\log\left(L^{M^{b}}_{y,j}\right), \hat{\sigma}_{L^{M^{b}}_{y,j}}\right]
(\#eq:L-Mb-data)
\end{equation}

for mean length data for the smolt tagging group.
Because the each population had approximately 1,000 fish tagged and measured during each tagging event, the standard errors on the mean length estimates were quite small.

Preliminary analyses revealed that parr mean length estimates had inter-annual variability attributable to the median sample date (capture method is active), so a standardization was devised and applied prior to model fitting [@justice-etal-2023, Figure 26 therein].
All uses of $\hat{L}^{P^{b}}_{y,j}$ in this document refer to the standardized version.
Although timing has varied for smolt mean length estimates ($\hat{L}^{M^{b}}_{y,j}$), it was caused by migratory timing not sample timing, thus should treated as process noise.

# Ocean Juvenile Phase

## Process Model

Spring Chinook salmon in the Grande Ronde basin migrate to sea as age-2 smolt and can return as either age-3, age-4, or age-5 adults.
That is, ocean juveniles spend between 1 and 3 winters at sea and some fraction make the return migration after each winter.
Thus, ocean dynamics were divided into two types of demographic rates: survival and maturation.
Attempting to freely estimate all desired parameters (i.e., time varying year-1, year-2, and year-3 survival rates and maturation rates after year-1 and year-2) revealed that these parameters were confounded given the available data, requiring more simplifying assumptions and stronger prior information than in other parts of the model.

### Survival Rates {#ocean-survival}

Year-1 natural-origin^[All $o=\NOR$ in eq. \@ref(eq:phi-O0-O1-random), omitted for brevity.] ocean survival was modeled as a multivariate logit-normal random variable around a time-constant expected value ($\dot{\phi}^{O^{0} \to O^{1}}_{o=\NOR,j}$) with covariance matrix $\Sigma_{\phi^{O^{0} \to O^{1}}}$, but included a lag-1 autoregressive process as a means to account for ocean conditions that may affect survival in a temporally non-independent fashion [e.g., @mantua-etal-1997]:

\begin{equation}
\logit\left(\boldsymbol{\phi}^{O^{0} \to O^{1}}_{y,o,1:n_j}\right) \sim \MVNdist\left\{\logit\left(\boldsymbol{\dot{\phi}}^{O^{0} \to O^{1}}_{o,1:n_j}\right) + \boldsymbol{\kappa}^{O^{0} \to O^{1}}_{1:n_j} \cdot \left[ \logit\left(\boldsymbol{\phi}^{O^{0} \to O^{1}}_{y-1,o,1:n_j}\right) - \logit\left(\boldsymbol{\dot{\phi}}^{O^{0} \to O^{1}}_{o,1:n_j}\right)\right], \Sigma_{\phi^{O^{0} \to O^{1}}} \right\}
(\#eq:phi-O0-O1-random)
\end{equation}

The first simplifying assumption surrounding ocean survival rates was that process variation was negligible in year-2 and year-3, thus we forced the brood year-specific values of $\phi^{O^{1} \to O^{2}}_{y,o=\NOR,j}$ and $\phi^{O^{2} \to O^{3}}_{y,o=\NOR,j}$ to take on the same value for all years (i.e., $\dot{\phi}^{O^{1} \to O^{2}}_{o=\NOR,j}$ and $\dot{\phi}^{O^{2} \to O^{3}}_{o=\NOR,j}$, respectively).
Further, it was discovered that reasonably strong priors would be needed to inform $\dot{\phi}^{O^{1} \to O^{2}}_{o=\NOR,j}$ and $\dot{\phi}^{O^{2} \to O^{3}}_{o=\NOR,j}$ to allow identifiability of the maturity parameters (Table \@ref(tab:param-table)); priors were used for ocean survival rather than maturity parameters because commonly assumed values were available for the former [@ctc-1988].
The second simplifying assumption was that natural- and hatchery-origin ocean survival rates were perfectly correlated across years within populations, but offset by a time-constant log-odds ratio ($\delta_{j}$):

\begin{equation}
\begin{aligned}
\logit\left(\phi^{O^{0} \to O^{1}}_{y,o=\HOR,j}\right) &= \logit\left(\phi^{O^{0} \to O^{1}}_{y,o=\NOR,j}\right) + \delta_j \\
\logit\left(\phi^{O^{1} \to O^{2}}_{y,o=\HOR,j}\right) &= \logit\left(\phi^{O^{1} \to O^{2}}_{y,o=\NOR,j}\right) + \delta_j \\
\logit\left(\phi^{O^{2} \to O^{3}}_{y,o=\HOR,j}\right) &= \logit\left(\phi^{O^{2} \to O^{3}}_{y,o=\NOR,j}\right) + \delta_j \\
\end{aligned}
(\#eq:get-phi-O-HOR)
\end{equation}

### Maturation Rates {#maturity}

Realized maturation rates (i.e., the proportion of fish from a given brood year alive and in the ocean at the beginning of a year that make the return migration that year) were modeled as multivariate logit-normal random variables around time-constant expected values ($\dot{\psi}^{O^{w}}_{o,j}$; $w$ is the number of winters spent in the ocean) with covariance matrix $\Sigma_{\psi^{O^{w}}}$ (assumed common across origins):

\begin{equation}
\begin{aligned}
\logit\left(\boldsymbol{\psi}^{O^{1}}_{y,o,1:n_j}\right) \sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\psi}}^{O^{1}}_{o,1:n_j}\right), \Sigma_{\psi^{O^{1}}}\right] \\
\logit\left(\boldsymbol{\psi}^{O^{2}}_{y,o,1:n_j}\right) \sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\psi}}^{O^{2}}_{o,1:n_j}\right), \Sigma_{\psi^{O^{2}}}\right]
\end{aligned}
(\#eq:psi-random)
\end{equation}

Since age-5 was the last modeled age of maturity, all fish alive and in the ocean after the third year at sea mature and return that year (i.e., all $\psi^{O^{3}}_{y,o,j} = 1$).

### Return to Columbia River {#return-to-columbia-river}

Based on the sources of process variation modeled in eqs. \@ref(eq:phi-O0-O1-random), \@ref(eq:get-phi-O-HOR), and \@ref(eq:psi-random) and the initial abundance of ocean juveniles ($O^{0}_{y,o,j}$, eq. \@ref(eq:get-O0)), the abundance of ocean juveniles after a given number of winters ($w$, superscripts in all $O^{w}$ symbols) was modeled as a sequence of survival, maturation of surviving fish, and survival of non-maturing fish:

\begin{equation}
\begin{aligned}
O^{1}_{y,o,j} &= O^{0}_{y,o,j} \cdot \phi^{O^{0} \to O^{1}}_{y,o,j} \\
O^{2}_{y,o,j} &= O^{1}_{y,o,j} \cdot (1 - \psi^{O^{1}}_{y,o,j}) \cdot \phi^{O^{1} \to O^{2}}_{y,o,j} \\
O^{3}_{y,o,j} &= O^{2}_{y,o,j} \cdot (1 - \psi^{O^{2}}_{y,o,j}) \cdot \phi^{O^{2} \to O^{3}}_{y,o,j} \\
\end{aligned}
(\#eq:get-Os)
\end{equation}

That is, fish reaching the ocean as age-2 juveniles ($O^{0}_{y,o,j}$) must survive one winter to become age-3 ocean juveniles ($O^{1}_{y,o,j}$); if they do not mature at age-3 (with probability $1 - \psi^{O^{1}}_{y,o,j}$), then they must survive another winter to become age-4 ocean juveniles ($O^{2}_{y,o,j}$), and if they do not mature at that point (with probability $1 - \psi^{O^{2}}_{y,o,j}$), they must survive a third winter to become age-5 ocean juveniles ($O^{3}_{y,o,j}$).

The abundances of ocean juveniles ($O^{1}_{y,o,j}$, $O^{2}_{y,o,j}$, and $O^{3}_{y,o,j}$) from a given cohort were organized by brood year, however they returned in different years and ages to spawn.
Returning mature fish were placed into the correct year and age of return to the mouth of the Columbia River before the upstream migration ($R^{b}_{y,k,o,j}$) based on the following rule: members of the cohort spawned in brood year $y$ returned at the $k^{\mathrm{th}}$ possible age of maturity to produce the cohort for brood year $y + A_{\mathrm{min}} + k - 1$.
As an example, fish spawned in brood year $y$ = 2000 will return in 2003 as age-3 ($k$ = 1), in 2004 as age-4 ($k$ = 2), or in 2005 as age-5 ($k$ = 3) -- see Table \@ref(tab:year-table) for a visual of this example.
Thus, the abundance of fish spawned in brood year $y$ returning as age-3, age-4, and age-5, respectively, was:

\begin{equation}
\begin{aligned}
R^{b}_{y+A_{\mathrm{min}} + 1 - 1,1,o,j} &= O^{1}_{y,o,j} \cdot \psi^{O^{1}}_{y,o,j} \\
R^{b}_{y+A_{\mathrm{min}} + 2 - 1,2,o,j} &= O^{2}_{y,o,j} \cdot \psi^{O^{2}}_{y,o,j} \\
R^{b}_{y+A_{\mathrm{min}} + 3 - 1,3,o,j} &= O^{3}_{y,o,j} \cdot \psi^{O^{3}}_{y,o,j} \\
\end{aligned}
(\#eq:get-Rbs)
\end{equation}

This, however, leaves 12 ($\sum_{k}^{n_k} A_{\mathrm{min}} + k - 1$) age/year combinations per origin unpopulated with returning adults (the first 3 missing years for age-3 returns, first 4 missing years for age-4 returns, and first 5 missing years for age-5 returns; see Table \@ref(tab:year-table)).
This occurs because no juvenile process model outcomes existed that would ultimately become these $R^{b}_{y,k,o,j}$ values in these early years.
Thus, to initialize the adult returns for natural-origin fish, these 12 year/age return abundances were estimated as unknown parameters with fairly restrictive priors (Table \@ref(tab:param-table)) with boundaries loosely informed by the ranges of adult returns-at-age observed in the early years of the data time series.
Initial abundances of age-specific hatchery-origin returns were handled by the "straying model" (see Section \@ref(processes-between-bon-and-lgr), below).

## Observation Model

No data sources were used to inform ocean juvenile population dynamics -- estimation of these quantities was enabled by (_i_) reasonably precise information about the abundance and composition of fish entering the ocean and returning to natal tributaries, (_ii_) the simplifying assumptions described above (i.e., time-constant second and third year ocean survival and perfectly correlated but offset origin-specific survival), and (_iii_) through the use of reasonably strong priors for second and third year ocean survival (Table \@ref(tab:param-table)).

# Freshwater Adult Phase

## Process Model

There are a variety of mortality sources that occur along the upstream migration from the mouth of the Columbia River to the point of spawning in natal tributaries in Grande Ronde basin.
For ease of presentation, we separate these processes into three categories depending on where they occur spatiotemporally: (_i_) downstream of Bonneville Dam (BON) at the beginning of the upstream migration, (_ii_) along the upstream migration in the mainstem Columbia and Snake rivers between BON and LGR, and (_iii_) after arrival to the natal tributaries and up until the point of spawning.

### Processes Downstream of BON

Prior to reaching BON, returning adults are subjected to harvest mortality from fisheries (harvest rate denoted by $U_{y,k,o}$; `r highlight("REPORT CITATION NEEDED")`).
These estimates were supplied to the model as known without error (i.e., non-stochastic; used in eq. \@ref(eq:get-Ra), below).

### Processes Between BON and LGR

Upon arrival to BON, survival to LGR has been monitored (since 2000; $y=10$) via PIT-tags with high (>0.95) detection probabilities, enabling estimation of survival along this portion of the migration.
The survival rate between BON and LGR was assumed to vary by origin (but not by population) as multivariate logit-normal random variables around expected values ($\dot{\phi}^{R^{b} \to R^{a}}_{o}$) with covariance matrix $\Sigma_{\phi^{R^{b} \to R^{a}}}$.
In years without these PIT-tag counts, however, the survival from BON to LGR was found to be confounded with ocean survival; this was resolved by using the expected value rather than estimating the value for these years:

\begin{equation}
\logit\left(\boldsymbol{\phi}^{R^{b} \to R^{a}}_{y,1:n_o}\right)
\begin{cases}
= \logit\left(\boldsymbol{\dot{\phi}}^{R^{b} \to R^{a}}_{1:n_o}\right) & \mbox{if $y < 10$}\\
\sim \MVNdist\left[\logit\left(\boldsymbol{\dot{\phi}}^{R^{b} \to R^{a}}_{1:n_o}\right), \Sigma_{\phi^{R^{b} \to R^{a}}} \right] & \mbox{if $y \ge 10$}
\end{cases}
(\#eq:phi-Rb-Ra-random)
\end{equation}

Examination of the adult composition data indicated that hatchery-origin adults returned to Grande Ronde populations in early years that could not be attributed to hatchery-origin smolt releases to these populations.
Further, the Minam River population (which has no hatchery supplementation program) has had hatchery adults found in carcass surveys in many of the years since monitoring began.
Without a process model adjustment, the observation model would treat these unexpected non-zero hatchery-origin counts as impossible.
This model component is referred to as the "straying model" (total abundance of entering strays denoted $G_{y,o,j}$), and it applied only in years/populations in which the presence of non-zero hatchery-origin returning adults could not otherwise be explained due to zero-valued hatchery-origin smolt releases.
Thus, all $G_{y,o=\NOR,j} = 0$ and all $G_{y,o=\HOR,j} = 0$ in years where non-zero hatchery-origin smolt releases to population $j$ could have explained non-zero hatchery-origin adult returns in year $y$ at age $k$.
The age composition of these strays was assumed to be time-constant ($p^{G}_{k,j}$; where $\sum_k^{n_k} p^{G}_{k,j} = 1$) and was used to apportion $G_{y,o,j}$.

The abundance of adults arriving to natal spawning tributaries by age and origin ($R^{a}_{y,k,o,j}$) as:

\begin{equation}
R^{a}_{y,k,o,j} = R^{b}_{y,k,o,j} \cdot (1 - U_{y,k,o}) \cdot \phi^{R^{b} \to R^{a}}_{y,o} + \left(G_{y,o,j} \cdot p^{G}_{k,j}\right)
(\#eq:get-Ra)
\end{equation}

### Processes in Natal Tributary

Upon arrival to the natal tributary, populations with a weir and hatchery program (all populations except the Minam River, indexed by $j = \MIN$) have some number of adults removed each year for broodstock and as a means to minimize natural spawning of hatchery-origin fish.
These weir removals (denoted by $B_{y,k,o,j}$; all $B_{y,k,o,j=\MIN} = 0$) were supplied to the model as known without error, as were the number of fish estimated to have been in the natal tributaries prior to spawning.
Thus, the abundance of potential spawners was:

\begin{equation}
S^{b}_{y,k,o,j} = \max\left(R^{a}_{y,k,o,j} - B_{y,k,o,j} - H_{y,k,o,j}, 1\right)
(\#eq:get-Sb)
\end{equation}

The maximum constraint was used to ensure all $S^{b}_{y,k,o,j} > 0$.

It is well-known that some potential spawners die prior to spawning; these "pre-spawn survival" outcomes, denoted by $\phi^{S^{b} \to S^{a}}_{y,j}$, were modeled as having time-constant values (i.e., all $\phi^{S^{b} \to S^{a}}_{y,j} = \dot{\phi}^{S^{b} \to S^{a}}_{j}$) for each population.
The initial desire was to allow for time-varying pre-spawn survival probabilities, but it was discovered that the observational data (counts of spawned vs. gravid female carcasses, see eq. \@ref(eq:prespawn-surv-data)) were not informative enough for all populations to prevent parameter confounding with egg-to-parr survival.

\begin{equation}
S^{a}_{y,k,o,j} = S^{b}_{y,k,o,j} \cdot \phi^{S^{b} \to S^{a}}_{y,j}
(\#eq:get-Sa)
\end{equation}

This $S^{a}_{y,k,o,j}$ value was used to calculate total egg production ($E_{y,j}$) in eq. \@ref(eq:get-E) to link the the spawner abundance to the parr recruitment abundance in the next generation.

## Observation Model

The adult observation model relied on three primary data types: (_i_) total abundance of adult returns to the natal tributaries, (_ii_) information about survival on the upstream migration between LGR and BON as well as on the spawning grounds, and (_iii_) composition data to inform the relative abundance of adults of different ages and origins returning each year.

### Abundance Data Source

Total tributary return abundance has been estimated annually external to the model using a combination of weir counts, mark-recapture methods, and spawning ground surveys (`r highlight("REPORT CITATION NEEDED")`).
For each population and year, these have been compiled into a point estimate ($\hat{R}^{a}_{y,j}$; the lack of $o$ or $k$ indices indicates the estimate is aggregated across these dimensions) and an estimate of observation uncertainty ($\hat{\sigma}_{R^{a}_{y,j}}$, expressed as a log-normal standard error).
The model assumed the point estimate is made with log-normal observation error around the model-predicted total returns to the tributary to build the likelihood for this component:

\begin{equation}
\log\left(\hat{R}^{a}_{y,j}\right) \sim \Ndist\left[\log\left(\sum_o^{n_o} \sum_k^{n_k} R^{a}_{y,k,o,j}\right), \hat{\sigma}_{R^{a}_{y,j}}\right]
(\#eq:Ra-data)
\end{equation}

### Survival Data Sources

The model fitted to counts of PIT-tag detections of known Grande Ronde-origin fish passing BON ($\hat{x}^{\mathrm{BON}}_{y,o}$) and LGR ($\hat{x}^{\mathrm{LGR}}_{y,o}$) to inform the migratory survival rate between these two locations, queried using the DART Adult Return Conversion Rate tool^[https://www.cbr.washington.edu/dart/query/pitadult_conrate; exact query settings described at https://github.com/bstaton1/GR-sslcm/issues/93.].
The latter was assumed to be a binomial random variable to build the likelihood component for this data set:

\begin{equation}
\hat{x}^{\mathrm{LGR}}_{y,o} \sim \Bdist\left(\phi^{R^{b} \to R^{a}}_{y,o}, \hat{x}^{\mathrm{BON}}_{y,o}\right)
(\#eq:upstream-surv-data)
\end{equation}

The other survival data set informing the freshwater adult observation model was for spawning success, i.e., pre-spawn survival.
Surveyors in annual spawning ground carcass surveys have recorded counts of total females encountered ($\hat{x}^{\mathrm{carcass,total}}_{y,j}$) and counts of those found to have successfully spawned ($\hat{x}^{\mathrm{carcass,spawned}}_{y,j}$; `r highlight("REPORT CITATION NEEDED")`).
These counts were treated as binomial random variables to build the likelihood:

\begin{equation}
\hat{x}^{\mathrm{carcass,spawned}}_{y,j} \sim \Bdist\left(\phi^{S^{b} \to S^{a}}_{y,j}, \hat{x}^{\mathrm{carcass,total}}_{y,j}\right)
(\#eq:prespawn-surv-data)
\end{equation}

### Composition Data Sources

Since the model is both age- and origin-structured, it required data to inform the relative abundance of adults returning according to these different classes.
These data took the form of two sources: (_i_) those collected at weirs located within three of the four populations ($\hat{x}^{R^{a}}_{y,ko,j}$) and (_ii_) those collected during carcass surveys ($\hat{x}^{S^{a^{\prime}}}_{y,ko,j}$), given the Minam River population does not have a weir.
The weir was assumed to have fish representatively with respect to age and origin composition and both data sources were fitted to by assuming multinomial sampling in which there were $n_{ko} = 6$ possible outcomes: $n_k = 3$ ages of return by $n_o = 2$ origins.
Further,the observed sample size ($\sum_{ko}^{n_{ko}} \hat{x}^{R^{a}}_{y,ko,j}$) as the multinomial sample size rather than attempting to adjust it for non-independent sampling [@maunder-2011]; alternative sample size selections would likely be arbitrary, and past analyses have suggested that inferences are robust to rational alternatives [see Supplement A of @staton-etal-2021].
The model-expected composition by age and origin ($p^{R^{a}}_{y,ko,j}$) was calculated from the return abundance by age and origin, reorganized such that age and origin fell along the same array dimension ($R^{a}_{y,ko,j}$) rather than along two dimensions as shown in the process model ($R^{a}_{y,k,o,j}$):

\begin{equation}
p^{R^{a}}_{y,ko,j} = \frac{R^{a}_{y,ko,j}}{\sum_{ko}^{n_{ko}} R^{a}_{y,ko,j}}
(\#eq:get-pRa)
\end{equation}

which was used as the multinomial expected frequency to build the likelihood:

\begin{equation}
\boldsymbol{\hat{x}}^{R^{a}}_{y,1:n_{ko},j} \sim \Mdist\left(\boldsymbol{p}^{R^{a}}_{y,1:n_{ko},j}, \sum_{ko}^{n_{ko}} \hat{x}^{R^{a}}_{y,ko,j}\right)
(\#eq:weir-comp-data)
\end{equation}

Preliminary analyses revealed an age sampling bias of carcass surveys relative to weir sampling, which required a correction to ensure reliable fits to all data sets while recovering unbiased true age composition data for the Minam River population, which had only carcass composition data.
For the three populations with paired composition data (i.e., $j \in [\CAT, \LOS, \UGR]$), correction factors were estimated in a hierarchical fashion:

\begin{equation}
z_{k,j} \sim \Ndist(\dot{z}_{k}, \sigma_{z_k})
(\#eq:z-random)
\end{equation}

where $k=1$ or $k=3$ ($k=2$ was treated as the baseline category), $z_{k,j}$ are age- and population-specific coefficients, $\dot{z}_{k}$ are their expectations across populations, and $\sigma_{z_k}$ are their standard deviations across populations.
These coefficients were used in the following log-linear model to derive the correction factors ($\zeta_{k,j}$):

\begin{equation}
\log\left(\zeta_{k,j}\right) = z_{k=1,j} \cdot \mathrm{age3}_k + z_{k=3,j} \cdot \mathrm{age5}_k
(\#eq:get-zeta-no-minam)
\end{equation}

where $k \in [1,2,3]$, $\boldsymbol{\mathrm{age3}}_{1:n_k} = [1~0~0]$ is a dummy variable indicating whether each value of $k$ corresponds to age-3, and $\boldsymbol{\mathrm{age5}}_{1:n_k} = [0~0~1]$ is a dummy variable indicating whether each value of $k$ corresponds to age-5.
These correction factors were averaged across populations to obtain the correction factors for the Minam River population:

\begin{equation}
\zeta_{k,j=\MIN} = \mathrm{mean}(\zeta_{k,j \in [\CAT, \LOS, \UGR]})
(\#eq:get-zeta-minam)
\end{equation}

These correction factors were used to calculate the expected proportions by age and origin for carcass surveys ($p^{S^{a^{\prime}}}_{y,ko,j}$):

\begin{equation}
p^{S^{a^{\prime}}}_{y,ko,j} = \frac{S^{a}_{y,ko,j} \cdot \zeta_{k,j}}{\sum_{ko}^{n_{ko}} S^{a}_{y,ko,j} \cdot \zeta_{k,j}}
(\#eq:get-pSa-prime)
\end{equation}

which was used as the multinomial expected frequency to build the likelihood by assuming:

\begin{equation}
\boldsymbol{\hat{x}}^{S^{a^{\prime}}}_{y,1:n_{ko},j} \sim \Mdist\left(\boldsymbol{p}^{S^{a^{\prime}}}_{y,1:n_{ko},j}, \sum_{ko}^{n_{ko}} \hat{x}^{S^{a^{\prime}}}_{y,ko,j}\right)
(\#eq:carcass-comp-data)
\end{equation}

\newpage

`r if (is_latex_output()) "BIB HERE"`

`r if (is_latex_output()) "\\newpage"`

# Figures {-}

\rhead{\empty}
\lhead{\empty}
\renewcommand{\headrulewidth}{0pt}

```{r diagram_fig_cap}
diagram_fig_cap = "Schematic of the primary states and transitions among states that are captured in the state-space life cycle model for Grande Ronde spring Chinook salmon."
```

```{r diagram, fig.cap = diagram_fig_cap, fig.pos = "H", out.extra = ""}
include_graphics("GR-sslcm-diagram.pdf")
```

`r if (is_latex_output()) "\\newpage"`

\missingfigure{Create a map figure to go here.}

\newpage

# Tables {-}

```{r index_table_cap}
index_tab_cap = "The various indices and dimensional constants used in defining the structure and scope for the state-space life cycle model for Grande Ronde spring Chinook salmon."
```

```{r index-table, warning = FALSE}
# read in csv version of table
tab = read.csv("01-indices.csv", allowEscapes = TRUE)

# prettier labels
type_key = c(
  "index" = "Indices",
  "scope" = "Scoping Constants",
  "dimension" = "Dimensional Constants"
)
tab$Type = type_key[as.character(tab$Type)]

# replace year variables
tab$Description = stringr::str_replace(tab$Description, "F_YEAR", "1991")
tab$Description = stringr::str_replace(tab$Description, "L_YEAR", "2022")
tab$Description = stringr::str_replace(tab$Description, "N_YEAR", as.character(length(1991:2022)))

# specify footnote text (requires LaTeX syntax, and all instances of \ require four "\\\\")
footnote_key = c(
  "1" = "``Population'' is used to distinguish among the tributaries within the Grande Ronde basin with sufficient data to model complete life cycle population dynamics. Abbreviations are: Catherine Creek (CAT), Lostine River (LOS), Minam River (MIN), and Upper Grande Ronde River (UGR).",
  "2" = "``Year'' refers to the year of spawning; for juvenile phases this is the year fish were spawned (i.e., brood year) and for adult phases this is the year of return (i.e., calendar year).",
  "3" = "``Age'' refers to the total age, i.e., the number of winters experienced (including the winter spent as an egg). For example, eggs fertilized in brood year 2000 were age-0 until they hatched in spring of 2001 (age-1), migrated to sea in spring/summer of 2002 (age-2), and returned to spawn in one of 2003 (age-3), 2004 (age-4), or 2005 (age-5). $k=1$ is the first age of maturation (age-3) and $k=3$ is the last age of maturation (age-5).",
  "4" = "``Migratory strategy'' refers to the timing of migration from headwaters rearing areas -- either as fall (as age-1) or spring (age-2) migrants. Regardless, all fish make the out-of-basin migration at age-2.",
  "5" = "``Origin'' refers to the rearing type: natural-origin (NOR) vs. hatchery-origin (HOR).",
  "6" = "Most quantities treat age ($k$) and origin ($o$) as two separate dimensions of a larger array. However, for fitting to compositional data by age and origin, we collapse these two dimensions into one. $ko \\\\in [1,2,3]$ represents age-3, age-4, and age-5 for natural-origin fish, respectively, and $ko \\\\in [4,5,6]$ represents these same ages for hatchery-origin fish, respectively."
)

# add footnote symbols where appropriate
tab$Description = paste0(ifelse(is.na(tab$Footnote), "", paste0("\\textsuperscript{", tab$Footnote, "}")), tab$Description)

# build the table
my_kable(x = tab[,1:3], caption = index_tab_cap) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD")) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(1, width = "50px") %>%
  column_spec(2, width = "50px") %>%
  column_spec(3, width = "332px") %>%
  collapse_rows(1, valign = "bottom", latex_hline = "major") %>%
  footnote(number = footnote_key, threeparttable = TRUE, escape = FALSE)
```

\newpage

```{r symbol_tab_cap}
symbol_tab_cap = "The symbology used to represent the key states (i.e., abundance at life stage/group) and rates (i.e., transition probabilities among states) in the presentation of the state-space life cycle model for Grande Ronde spring Chinook salmon. The majority of rates presented in this table are hierarchically structured/estimated, where the population- and/or origin-specific expected value and standard deviation are free parameters (or a function of free parameters) presented in Table \\ref{tab:param-table}. Equation numbers reference any equation that uses that quantity -- these may include the equation where the quantity is first defined, where it is used in process model, or where it is used in the observation model."
```

```{r symbol-table, warning = FALSE}
tab = read.csv("02-symbols.csv", allowEscapes = TRUE)

type_key = c(
  "state" = "States",
  "rate" = "Rates"
)

tab$Type = type_key[as.character(tab$Type)]

handle_eqs = function(x) {
  if (x == "") {
    out = ""
  } else {
    x_split = unlist(stringr::str_split(x, ","))
    x_split = stringr::str_remove_all(x_split, " ")
    if (is_latex_output()) {
      x_refs = paste0("\\ref{eq:", x_split, "}")
    } else {
      x_refs = paste0("\\@ref(eq:", x_split, ")")
    }
    out = paste(x_refs, collapse = ", ")
  }
  return(out)
}

tab$Eqs. = unname(sapply(tab$Eqs., handle_eqs))
colnames(tab)[4] = "Eq(s)."

my_kable(x = tab[,2:5], caption = symbol_tab_cap, longtable = TRUE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD", "repeat_header")
                # repeat_header_continued = "\\textit{(Continued on next page...)}"
                ) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Freshwater Juvenile", min(which(tab$Phase == 1)), max(which(tab$Phase == 1)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Ocean Juvenile", min(which(tab$Phase == 2)), max(which(tab$Phase == 2)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Freshwater Adult", min(which(tab$Phase == 3)), max(which(tab$Phase == 3)), bold = TRUE, hline_after = TRUE) %>%
  column_spec(1, width = "25px") %>%
  column_spec(2, width = "50px") %>%
  column_spec(3, width = "50px") %>%
  column_spec(4, width = "300px") %>%
  collapse_rows(1, valign = "bottom", latex_hline = "full")
```

\newpage

```{r param_tab_cap}
param_tab_cap = "All free parameters (i.e., that have a prior that is not function of other free parameters) estimated by the state-space life cycle model for Grande Ronde spring Chinook salmon. Distributions and their parameterizations are defined in the footnotes."
```

```{r param-table, warning = FALSE}
tab = read.csv("03-params.csv", allowEscapes = TRUE)

tab$Eqs. = unname(sapply(tab$Eqs., handle_eqs))

footnote_key = c(
  "1" = "Beta Distribution: $b(\\\\mathrm{shape}_1$, $\\\\mathrm{shape}_2)$",
  "2" = "Normal Distribution: $\\\\mathcal{N}(\\\\mathrm{mean}$, $\\\\mathrm{precision})$",
  "3" = "Uniform Distribution: $\\\\mathcal{U}(\\\\mathrm{lower}$, $\\\\mathrm{upper})$",
  "4" = "$t$-Distribution: $t$(mean, precision, degrees of freedom); this prior results in approximately a $\\\\mathcal{U}(0,1)$ prior after inverse-logit transformation \\\\citep{dorazio-etal-2011}.",
  "5" = "Dirichlet Distribution: $\\\\mathcal{D}(\\\\mathrm{shape}_1$, $\\\\mathrm{shape}_2$, $\\\\mathrm{shape}_3)$",
  "6" = "Scaled Inverse-Wishart Distribution: $\\\\mathcal{SIW}$(\\\\textbf{S}, degrees of freedom); \\\\textbf{S} is a vector of scale parameters for scaled-Wishart; see \\\\cite{plummer-2017} page 62 for details on this prior. Briefly, the scale parameters of 0.10 - 0.30 places higher prior weight on small values of the component $\\\\sigma$ parameters, which was intentional because these represent variability on the log- or logit-scale. Setting the degrees of freedom to 2 results in a $\\\\mathcal{U}(-1,1)$ prior on the $\\\\rho$ components."
)

colnames(tab)[3] = "Prior\\textsuperscript{1,2,3,4,5,6}"
colnames(tab)[4] = "Eq."

if (!is_latex_output()) {
  tab$Description = stringr::str_replace_all(tab$Description, "``", '"')
  tab$Description = stringr::str_replace_all(tab$Description, "''", '"')
}

my_kable(x = tab[,2:5], caption = param_tab_cap, longtable = TRUE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD", "repeat_header")
                # repeat_header_continued = "\\textit{(Continued on next page...)}"
                ) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Freshwater Juvenile", min(which(tab$Phase == 1)), max(which(tab$Phase == 1)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Ocean Juvenile", min(which(tab$Phase == 2)), max(which(tab$Phase == 2)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Freshwater Adult", min(which(tab$Phase == 3)), max(which(tab$Phase == 3)), bold = TRUE, hline_after = TRUE) %>%
  column_spec(1, width = "50px") %>%
  column_spec(2, width = "65px") %>%
  column_spec(3, width = "20px") %>%
  column_spec(4, width = "290px") %>%
  row_spec(1:(nrow(tab)-1), hline_after = TRUE) %>%
  footnote(number = footnote_key, number_title = "Prior Distributions:", title_format = c("italic", "underline"), escape = FALSE, threeparttable = TRUE)
```

\newpage

```{r data_tab_cap}
data_tab_cap = "The symbology used to represent the data sources in the presentation of observation model components of the state-space life cycle model for Grande Ronde spring Chinook salmon. All data sources listed here have an explicit likelihood component and were thus assumed to be observed with error."
```

```{r data-table, warning = FALSE}
tab = read.csv("04-data.csv", allowEscapes = TRUE)

type_key = c(
  "abund" = "Abundance",
  "surv" = "Survival",
  "length" = "Length",
  "comp" = "Composition"
)

tab$Eqs. = unname(sapply(tab$Eqs., handle_eqs))

tab$Type = type_key[as.character(tab$Type)]

colnames(tab)[4] = "Eq."

my_kable(x = tab[,2:5], caption = data_tab_cap, longtable = TRUE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD", "repeat_header")
                # repeat_header_continued = "\\textit{(Continued on next page...)}"
                ) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Freshwater Juvenile", min(which(tab$Phase == 1)), max(which(tab$Phase == 1)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Freshwater Adult", min(which(tab$Phase == 3)), max(which(tab$Phase == 3)), bold = TRUE, hline_after = TRUE) %>%
  column_spec(1, width = "50px") %>%
  column_spec(2, width = "70px") %>%
  column_spec(3, width = "20px") %>%
  column_spec(4, width = "295px") %>%
  collapse_rows(1, valign = "bottom", latex_hline = "full")
```

\newpage

```{r equation_tab_cap}
equation_tab_cap = "Catalog of all equations presented, separated by life phase (freshwater juvenile, ocean juvenile, or freshwater adult) and model component (process model or observation model)."
```

```{r equation-table, warning = FALSE}
tab = read.csv("05-equations.csv", allowEscapes = TRUE)

component_key = c(
  "syntax" = "Syntax",
  "process" = "Process",
  "observation" = "Observation"
)

tab$Eq. = unname(sapply(tab$Eq., handle_eqs))

tab$Component = component_key[as.character(tab$Component)]
colnames(tab)[2] = "Model Component"

my_kable(x = tab[,2:4], caption = equation_tab_cap, longtable = TRUE, align = "lrl") %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD", "repeat_header")
                # repeat_header_continued = "\\textit{(Continued on next page...)}"
                ) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Generic", min(which(tab$Phase == 0)), max(which(tab$Phase == 0)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Freshwater Juvenile", min(which(tab$Phase == 1)), max(which(tab$Phase == 1)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Ocean Juvenile", min(which(tab$Phase == 2)), max(which(tab$Phase == 2)), bold = TRUE, hline_after = TRUE) %>%
  pack_rows("Freshwater Adult", min(which(tab$Phase == 3)), max(which(tab$Phase == 3)), bold = TRUE, hline_after = TRUE) %>%
  column_spec(1, width = "55px") %>%
  column_spec(2, width = "15px") %>%
  column_spec(3, width = "365px") %>%
  collapse_rows(1, valign = "bottom", latex_hline = "major")
```

\newpage

```{r}
year_tab_caption = "Year of return based on age of return and brood year. For example, adults that were progeny of spawners in 2000 (their brood year) returned to spawn in 2003 as age-3, 2004 as age-4, and 2005 as age-5 (shown in blue). The return years with red brood years show the age-specific return abundances that were estimated because no previous states (e.g., parr, smolt) were available for these early brood years (see Section \\ref{return-to-columbia-river} for more details)."
```

```{r year-table, warning = FALSE}

return_year = 1991:2022
age_3 = 1988:2019
age_4 = 1987:2018
age_5 = 1986:2017

tab_full = data.frame(return_year, age_3, age_4, age_5)
tab_NA = data.frame(return_year = NA, age_3 = NA, age_4 = NA, age_5 = NA)

tab_start = tab_full[tab_full$return_year %in% c(1991:1996),]
tab_end = tab_full[tab_full$return_year %in% c(2022),]
tab_middle = tab_full[tab_full$return_year %in% c(2003:2005),]
tab = rbind(tab_start, tab_NA, tab_middle, tab_NA, tab_end)

tab[,-1][tab[,-1] < 1991 & !is.na(tab[,-1])] = kableExtra::cell_spec(tab[,-1][tab[,-1] < 1991 & !is.na(tab[,-1])], format = "latex", color = "red")
tab[,-1][tab[,-1] == 2000 & !is.na(tab[,-1])] = kableExtra::cell_spec(tab[,-1][tab[,-1] == 2000 & !is.na(tab[,-1])], format = "latex", color = "blue")

tab[is.na(tab)] = "$\\vdots$"

my_kable(x = tab, align = "cccc", col.names = c("Return Year", "Age-3", "Age-4", "Age-5"), 
         caption = year_tab_caption, row.names = FALSE) %>%
  kable_styling(full_width = FALSE) %>%
  add_header_above(c(" " = 1, "Brood Year of Returning Adults by Age" = 3), bold = TRUE) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2:4, width = "50px")
```

\newpage
`r if (!is_latex_output()) "# References {-}"`
