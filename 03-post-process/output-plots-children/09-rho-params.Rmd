---
editor_options: 
  chunk_output_type: console
---

# Correlation Parameters {.tabset .tabset-pills}

## Summary Across Processes

```{r summarize-rho-means}
# get posterior summaries of the mean correlation across all pop pairs
# for each process separately
rho_params1 = match_params(post, "rho", type = "base_only")
rho_params2 = match_params(post, "rho_.+_pr", type = "base_only")
rho_params = rho_params1[!(rho_params1 %in% rho_params2)]
f = function(p) {
  x = rowMeans(post_subset(post, p, matrix = TRUE))
  c(mean = mean(x), sd = sd(x), quantile(x, c(0.1, 0.25, 0.5, 0.75, 0.9)))
}
rho_mean_out = t(sapply(rho_params, f))
rho_mean_out = rho_mean_out[order(rho_mean_out[,"mean"]),]

# assign names to the different rho parameters
rho_labels = c(
  "rho_Lphi_E_Pb" = "Egg-to-Parr Survival",
  "rho_Lphi_O0_O1" = "Yr1 Ocean Survival",
  "rho_Lpsi_O1" = "Pr(Mature Age-3)",
  "rho_Lpsi_O2" = "Pr(Mature Age-4)",
  "rho_lDelta_L_Pb_Mb" = "'Growth' Factor",
  "rho_Lphi_Mb_Ma" = "Trib. to LGR Survival",
  "rho_lL_Pb" = "Mean Parr Length",
  "rho_Lphi_Pa_Mb" = "Overwinter Survival",
  "rho_Lphi_Sb_Sa" = "Pre-spawn Survival",
  "rho_Lphi_Rb_Ra" = "BON -> UGR Survival",
  "rho_Lpi" = "Pr(Fall Migrant)",
  "rho_Lphi_Ma_O0" = "LGR -> Ocean Survival"
)
```

Posterior summaries of the correlation matrices for all process model components that used a multivariate (logit- or log-) normal distribution model inter-annual variability.
All processes assumed covariance among population pairs except "LGR to Ocean" and "BON to LGR", which had equal values for all populations but covaried across origin types.

Notation:

* Blue: Mean of all population pairs ("+" = posterior mean, thick lines = 50% CRI, thin lines = 80% CRI)
* Red: Individual population pairs ("+" = posterior mean, lines = 50% CRI)
* Grey: Prior distribution (95%, 80%, and 50% CRIs in increasing darkness)

```{r rho-mean-plot, fig.width = 5, fig.height = 5}
# plot to show summary of correlation parameters across processes
# mean across pairs shown as blue
# individual population pairs shown as red

# set up empty plotting region
par(mar = c(2,8,1,1), cex.axis = 0.8, lend = "square", tcl = -0.15, mgp = c(2,0.35,0), yaxs = "i", lend = "square", ljoin ="mitre")
mp = barplot(rho_mean_out[,"mean"], 
             horiz = TRUE, xlim = c(-1,1),
             names.arg = rho_labels[rownames(rho_mean_out)],
             las = 1, col = "white", border = "white")
usr = par("usr")

# draw on the prior distribution
rho_pr = post_summ(post, "rho_Lphi_Ma_O0_pr[2,1]", probs = c(0.025, 0.1, 0.25, 0.75, 0.9, 0.975))
rect(rho_pr["2.5%",], usr[3], rho_pr["97.5%",], usr[4], col = scales::alpha("grey25", 0.15), border = NA)
rect(rho_pr["10%",], usr[3], rho_pr["90%",], usr[4], col = scales::alpha("grey25", 0.15), border = NA)
rect(rho_pr["25%",], usr[3], rho_pr["75%",], usr[4], col = scales::alpha("grey25", 0.15), border = NA)
abline(v = 0, lty = 2)

# param = rownames(rho_mean_out)[4]
# at_mp = mp[4,]
pop_rhos = function(param, at_mp) {
  
  # if the process is not one of the hydropower migration survival ones, do this
  # those processes are correlated across origins, because all populations share the same values each year
  if (!(param %in% c("rho_Lphi_Ma_O0", "rho_Lphi_Rb_Ra"))) {
    x = post_summ(post, paste0(param, vcov_inds), probs = c(0.1, 0.25, 0.75, 0.9))
    y = at_mp + runif(6, -0.4, 0.4)
    points(y ~ x["mean",], col = "salmon", pch = 3, lwd = 1.5)
    segments(x["25%",], y, x["75%",], y, col = scales::alpha("salmon", 0.5))
  } 
}

junk = sapply(1:nrow(mp), function(i) pop_rhos(rownames(rho_mean_out)[i], mp[i,]))
segments(rho_mean_out[,"25%"], mp, rho_mean_out[,"75%"], mp, lwd = 6, col = scales::alpha("royalblue", 0.55))
segments(rho_mean_out[,"10%"], mp, rho_mean_out[,"90%"], mp, col = scales::alpha("royalblue", 0.55))
points(mp ~ rho_mean_out[,"mean"], pch = 3, cex = 1, col = "royalblue", lwd = 3)

abline(h = mp + rbind(diff(mp)/2, NA), xpd = FALSE, col = "grey50", lty = 2)
par(tcl = -7)
axis(side = 2, at = mp + rbind(diff(mp)/2, NA), col = "grey50", line = NA, labels = FALSE, lty = 2)
box()
```

