---
editor_options: 
  chunk_output_type: console
---

# Equivilency Rates {.tabset .tabset-pills}

## Smolt-to-Adult Rates {.tabset .tabset-pills}

### LGR to Tributary

This is survival from $Ma$ (smolts at the top of LGD) to $Ra$ (adults returning to tributary, vulnerable to being counted at weir).

The adult part is calculated across return years, by summing the number of adults of each age that return in the appropriate years. For example, the SAR for brood year 1991 uses smolt that were spawned in 1991, out-migrated in spring 1993, divided by the sum of age 3 adults in 1994, age 4 adults in 1995, and age 5 adults in 1996. The calculation is done for hatchery and natural origin fish separately. Only SARs through brood year 2014 are calculated, since this is the last year of complete adult returns.

```{r adults-per-smolt, fig.width = p4_width, fig.height = p4_height}
j = 1

plot_fn = function(j) {
  # which years had zero hatchery smolt released
  zero_hor_smolt = post_summ(post, sub_index("Mb[year,LH_type,origin,pop]", year = sar_yrs, LH_type = i_spring, origin = o_hor, pop = j))["mean",] == 0
  
  # summarize rates
  Ra_per_Ma_nor = post_summ(post, sub_index("Ra_per_Ma[year,origin,pop]", year = sar_yrs, origin = o_nor, pop = j)) * 100
  Ra_per_Ma_hor = post_summ(post, sub_index("Ra_per_Ma[year,origin,pop]", year = sar_yrs, origin = o_hor, pop = j)) * 100
  
  # make hatchery values NA in year with no smolt
  Ra_per_Ma_hor[,zero_hor_smolt] = NA
  
  # plot natural origin time series
  plot_tseries(est = Ra_per_Ma_nor, yrs = all_yrs[sar_yrs], label_text = pops[j], ylim = c(0, 10))
  
  # add hatchery origin time series
  add_tseries(est = Ra_per_Ma_hor, yrs = all_yrs[sar_yrs])
  
  if (j == 2) {
    legend("topright", legend = origins, title = "Origin",
           pch = 22, col = main_cols[c("model", "model2")], pt.cex = 2, pt.bg = tran_cols[c("model", "model2")], bty = "n", cex = 0.8)
  }
}
mypar()
junk = sapply(1:jags_data$nj, plot_fn)
axis_labels("Brood Year", "Adults per 100 Smolt")
```

### BON to BON

```{r bon-to-bon, fig.width = p4_width, fig.height = p4_height}
plot_fn = function(j) {
  # which years had zero hatchery smolt released
  zero_hor_smolt = post_summ(post, sub_index("Mb[year,LH_type,origin,pop]", year = sar_yrs, LH_type = i_spring, origin = o_hor, pop = j))["mean",] == 0
  
  # summarize rates
  phi_nor = post_summ(post, sub_index("phi_O0_Rb_BON[year,origin,pop]", year = sar_yrs, origin = o_nor, pop = j))
  phi_hor = post_summ(post, sub_index("phi_O0_Rb_BON[year,origin,pop]", year = sar_yrs, origin = o_hor, pop = j))
  
  # get a max value for ylim
  ymax = max(post_summ(post, sub_index("phi_O0_Rb_BON[year,origin,pop]", year = sar_yrs, origin = o_nor, pop = "."))["97.5%",])
  
  # make hatchery values NA in year with no smolt
  phi_hor[,zero_hor_smolt] = NA
  
  # plot natural origin time series
  plot_tseries(est = phi_nor, yrs = all_yrs[sar_yrs], label_text = pops[j], ylim = c(0, ymax))
  
  # add hatchery origin time series
  add_tseries(est = phi_hor, yrs = all_yrs[sar_yrs])
  
  if (j == 2) {
    legend("topright", legend = origins, title = "Origin",
           pch = 22, col = main_cols[c("model", "model2")], pt.cex = 2, pt.bg = tran_cols[c("model", "model2")], bty = "n", cex = 0.8)
  }
}
mypar()
junk = sapply(1:jags_data$nj, plot_fn)
axis_labels("Brood Year", "BON \u2192 BON Survival")
```

## Parr per Spawner

"Spawner" means total spawners that survive pre-spawn mortality.

```{r parr-per-spawner, fig.width = p4_width, fig.height = p4_height}
plot_fn = function(j) {
  plot_tseries(est = post_summ(post, sub_index("Pb_per_Sa_tot[year,pop]", pop = j, year = ts_yrs)), yrs = all_yrs[ts_yrs], label_text = pops[j])
}

mypar()
junk = sapply(1:jags_data$nj, plot_fn)
axis_labels("Brood Year", "Parr per Spawner")
```

## Smolt per Spawner

"Smolt" means total NOR smolt that survive their second winter, immediately prior to migration out of basin.

```{r smolt-per-spawner, fig.width = p4_width, fig.height = p4_height}
plot_fn = function(j) {
  plot_tseries(est = post_summ(post, sub_index("Mb_per_Sa_tot[year,pop]", pop = j, year = ts_yrs)), yrs = all_yrs[ts_yrs], label_text = pops[j])
}

mypar()
junk = sapply(1:jags_data$nj, plot_fn)
axis_labels("Brood Year", "Smolt per Spawner")
```

## Spawners per Spawner

This is the sum of all spawners that were produced by the spawners in a given brood year (i.e., accounts for adult recruits returning across multiple ages/years). "Brood year" refers to the year the returning production was spawned. 

```{r spawners-per-spawner, fig.width = p4_width, fig.height = p4_height}
plot_fn = function(j) {
  plot_tseries(est = post_summ(post, sub_index("Sa_tot_per_Sa_tot[year,pop]", pop = j, year = sar_yrs)), yrs = all_yrs[sar_yrs], label_text = pops[j])
  abline(h = 1, lty = 2)
}
mypar()
junk = sapply(1:jags_data$nj, plot_fn)
axis_labels("Brood Year", "Spawners per Spawner")
```
