---
title: "Output Summary"
subtitle: "`r c('CAT' = 'Catherine Creek', 'LOS' = 'Lostine', 'UGR' = 'Upper Grande Ronde')[params$pop]`"
output: html_document
params:
  pop:
    label: "Population"
    value: CAT
    input: select
    choices: [CAT, LOS, UGR]
editor_options: 
  chunk_output_type: console
---

```{r directories, include = F}
# set root directory to the project directory: one level up from this location
knitr::opts_knit$set(root.dir = "../")
```

```{r setup, include = FALSE}
# set global knitting options
knitr::opts_chunk$set(echo = FALSE, fig.align = "center")

# load packages
source("00-packages.R")

# load all necessary functions
invisible(sapply(list.files(path = "01-functions", pattern = "\\.R$", full.names = T), source))

# set the input directory
in_dir = "02-model/model-output"

# read information from this model
model_info = readRDS(file.path(in_dir, paste0(params$pop, "-output.rds")))

# extract the two key structures from this object
post = model_info$post
jags_data = model_info$jags_data

# which years are "observable"?
observable = (jags_data$kmax+1):jags_data$ny
```

The code used to render this output relies heavily on Staton's 'postpack' package (currently under CRAN review). Take a look at [this vignette](https://bstaton1.github.io/postpack/articles/feature-overview.html) for a primer on how to use it.

# Fit to Data {.tabset .tabset-pills}

In the figures below, the thick red line is the posterior median value each year, the red region is the equal-tailed 95% credible interval, and blue points are "observed" data (estimated from raw data external to the model).

## Abundance Data

```{r abundance-data-fits, fig.width = 3, fig.height = 5}
par(mfcol = c(3,1), oma = c(1.5,1.5,0,0))
plot_tseries(post_summ(post, "^Pa[.+,1]$"), jags_data$Pa_obs[observable,1], main = "Fall Trap Abundance")
plot_tseries(post_summ(post, "^Mb[.+,2]$"), jags_data$Mb_obs[observable,2], main = "Spring Trap Abundance")
plot_tseries(post_summ(post, "^Ra_tot["), jags_data$Ra_obs[observable], main = "Weir Abundance")
mtext(side = 1, outer = T, line = 0.25, "Brood Year")
mtext(side = 2, outer = T, line = 0.25, "Abundance")
```

## Survival Data

```{r survival-data-fits, fig.width = 3, fig.height = 5}
par(mfcol = c(3,1), oma = c(1.5,1.5,0,0))

plot_tseries(post_summ(post, "^phi_Pb_Ma["), expit(jags_data$Lphi_obs_Pb_Ma[observable]), main = "Summer Tagging to LGD")
plot_tseries(post_summ(post, "^phi_Pa_Ma[.+,1]$"), expit(jags_data$Lphi_obs_Pa_Ma[observable,1]), main = "Fall Trap to LGD")
plot_tseries(post_summ(post, "^phi_Mb_Ma[.+,2]$"), expit(jags_data$Lphi_obs_Mb_Ma[observable,2]), main = "Spring Trap to LGD")
mtext(side = 1, outer = T, line = 0.25, "Brood Year")
mtext(side = 2, outer = T, line = 0.25, "Survival")
```

## Composition Data

```{r comp-data-fits, fig.width = 6, fig.height = 5}
# calculate observed q
q_obs = t(apply(jags_data$x_obs, 1, function(y) y/sum(y)))

par(mfcol = c(3,2), oma = c(1.5,1.5,0,0))
plot_tseries(post_summ(post, "^q[.+,1]$"), q_obs[observable,1], main = "Female Age 3")
plot_tseries(post_summ(post, "^q[.+,2]$"), q_obs[observable,2], main = "Female Age 4")
plot_tseries(post_summ(post, "^q[.+,3]$"), q_obs[observable,3], main = "Female Age 5")
plot_tseries(post_summ(post, "^q[.+,4]$"), q_obs[observable,4], main = "Male Age 3")
plot_tseries(post_summ(post, "^q[.+,5]$"), q_obs[observable,5], main = "Male Age 4")
plot_tseries(post_summ(post, "^q[.+,6]$"), q_obs[observable,6], main = "Male Age 5")
mtext(side = 1, outer = T, line = 0.25, "Brood Year")
mtext(side = 2, outer = T, line = 0.25, "Proportion of Return")
```

# Spawner-to-Parr Relationship

All red component are posterior summaries (medians and 95% credible intervals). The black curve is from an `nls()` fit on reconstructed parr and spawners -- the grey region is the confidence interval around this fit (from a parametric bootstrap).

```{r spawners-to-parr, fig.width = 6, fig.height = 4}
# extract posterior samples of the BH productivity and capacity parameters
bh_params = post_subset(post, c("alpha", "beta"), matrix = T)

# extract posterior summaries of total spawners by brood year
Sa_tot = post_summ(post, "Sa_tot")

# extract posterior summaries of total parr recruits by brood year
Pb = post_summ(post, "^Pb[")

# predict parr recruits along a sequence of spawner abundances
Sa_pred = seq(0, max(Sa_tot[5,]), length = 30)
Pb_pred = t(sapply(1:post_dim(post, "saved"), function(i) BH(Sa_pred, bh_params[i,1], bh_params[i,2])))
colnames(Pb_pred) = paste0("Pb_pred[", 1:length(Sa_pred), "]")
Pb_pred = post_convert(cbind(postpack:::id_mat(post), Pb_pred))
Pb_pred = post_summ(Pb_pred, "Pb_pred")

# fit ordinary least squares version
ols_fit = fit_basic_BH(jags_data)$BH_fit

# draw 1000 random parameters
ols_params = exp(rmvnorm(1000, coef(ols_fit), vcov(ols_fit)))

# calculate predicted curve at each pair/summarize
ols_R_pred = t(sapply(1:1000, function(i) BH(Sa_pred, ols_params[i,1], ols_params[i,2])))
ols_R_pred = apply(ols_R_pred, 2, function(x) quantile(x, c(0.5, 0.025, 0.975)))

# graphical parameters
par(mar = c(3,3,1,1), mgp = c(2,0.3,0), tcl = -0.2)

# empty plot
plot(1, 1, type = "n", xlim = range(0, Sa_tot[5,]), ylim = range(0, Pb[5,], Pb_pred[5,]),
     xlab = "Spawners", ylab = "Parr Recruits")

# draw fitted relationship: Bayesian
polygon(c(Sa_pred, rev(Sa_pred)), c(Pb_pred[4,], rev(Pb_pred[5,])), col = alpha("salmon", 0.5), border = NA)
lines(Pb_pred[4,] ~ Sa_pred, col = "red", lty = 2)
lines(Pb_pred[5,] ~ Sa_pred, col = "red", lty = 2)

# draw fitted relationship: OLS
polygon(c(Sa_pred, rev(Sa_pred)), c(ols_R_pred[2,], rev(ols_R_pred[3,])), col = alpha("grey", 0.5), border = NA)
lines(ols_R_pred[1,] ~ Sa_pred, lwd = 2)
lines(ols_R_pred[2,] ~ Sa_pred, lty = 2)
lines(ols_R_pred[3,] ~ Sa_pred, lty = 2)
lines(Pb_pred[3,] ~ Sa_pred, col = "red", lwd = 2)

# draw state pairs + uncertainty
segments(Sa_tot[4,], Pb[3,], Sa_tot[5,], Pb[3,], col = "red")
segments(Sa_tot[3,], Pb[4,], Sa_tot[3,], Pb[5,], col = "red")
points(Pb[3,] ~ Sa_tot[3,], pch = 21, col = "red", bg = alpha("salmon", 0.5))
```

